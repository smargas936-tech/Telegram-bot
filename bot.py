# bot.py
import telebot
import random
import json
import os
from telebot import types

TOKEN = "8422312912:AAGFXRT2ZKSPvCvMuqKCqoRaAmmWToRB_ok"
SPONSORS = ["@muzhskiymuzhchiny", "@dozik_Q", "@quot001"]

STATE_FILE = "quotes_state.json"

bot = telebot.TeleBot(TOKEN)

# Список из 100 цитат на русском, только текст (без тире, без авторов)
QUOTES = [
"Будь собой",
"Жизнь это то что с тобой происходит пока ты строишь планы",
"Делай что можешь с тем что у тебя есть там где ты есть",
"Не важно как медленно ты идешь главное не останавливаться",
"Счастье это путь а не пункт назначения",
"Верь в себя и всё получится",
"Каждый день новая возможность изменить свою жизнь",
"Делай то что любишь и ты не будешь работать ни дня в жизни",
"Сила воли это то что делает невозможное возможным",
"Лучше сделать и пожалеть чем не сделать и пожалеть всю жизнь",
"Не сравнивай себя с другими сравнивай себя с собой вчерашним",
"Мечты не работают пока ты не работаешь",
"Тот кто хочет ищет возможности кто не хочет ищет причины",
"Секрет перемен сосредоточить всю энергию не на борьбе со старым а на создании нового",
"Ошибки это лестница успеха",
"Вдохновение приходит во время действия",
"Ты сильнее чем думаешь",
"Дорогу осилит идущий",
"Не бойся делать ошибки бойся не делать ничего",
"Счастье зависит от нас самих",
"Трудности это возможности в рабочей одежде",
"Будущее создаётся сегодня а не завтра",
"Начни с малого но начни",
"Терпение и труд всё перетрут",
"Если хочешь быть счастливым будь им",
"Великие дела начинаются с маленьких шагов",
"Не жди когда придёт счастье создай его сам",
"Учись каждый день это путь к успеху",
"Самое трудное это решение действовать",
"Сильный не тот кто никогда не падает а тот кто поднимается каждый раз",
"Не откладывай на завтра то что можешь сделать сегодня",
"Счастье это когда ты ценишь мелочи",
"Смелость это страх который сказал свои молитвы",
"Жизнь измеряется не количеством вдохов а моментами когда захватывает дух",
"Успех это идти от поражения к поражению не теряя энтузиазма",
"Лучший способ предсказать будущее создать его",
"Счастье не в вещах а в моментах",
"Действуй даже если страшно",
"Знание сила но мудрость применение знания",
"Не смотри назад с сожалением смотри вперёд с надеждой",
"Слушай своё сердце но бери с собой разум",
"Только действие создаёт результаты",
"Не жди идеальных условий действуй сейчас",
"Неудачи это просто возможность начать снова но более мудро",
"Самое главное не сдаваться",
"Счастье это когда ты живёшь настоящим",
"Успех приходит к тем кто действует",
"Каждое утро это новый шанс",
"Не бойся быть другим",
"Делай каждый день что то что пугает тебя",
"Слушай других но живи своей жизнью",
"Верь в лучшее но будь готов к худшему",
"Дружба это подарок который нужно беречь",
"Маленькие шаги ведут к большим победам",
"Простые вещи часто самые важные",
"Честность это лучшая политика",
"Улыбка меняет мир вокруг тебя",
"Твоя энергия притягивает твою реальность",
"Будь благодарен за то что имеешь",
"Мир внутри тебя отражается вокруг",
"Любовь делает жизнь богаче",
"Не сравнивай свои достижения с чужими",
"Каждый день это шанс стать лучше",
"Не позволяй страху управлять тобой",
"Ставь цели и действуй",
"Прости себя и двигайся вперёд",
"Слушай больше чем говоришь",
"Делай сегодня то что другие не хотят чтобы завтра иметь то что другие не имеют",
"Самое важное начать",
"Живи так чтобы не жалеть",
"Приложи усилия и судьба откроет двери",
"Будь терпим к себе и к другим",
"Твоя жизнь это твой выбор",
"Преодоление делает тебя сильнее",
"Любые ограничения существуют в нашей голове",
"Твори и не жди похвалы",
"Чем больше отдаёшь тем больше получаешь",
"Не бойся просить о помощи",
"Делай добро без ожидания награды",
"Риск иногда единственный путь к росту",
"Учись на своих ошибках быстро и продолжай",
"Не забывай про отдых он важен",
"Твои привычки создают твое будущее",
"Цени своих близких",
"Уважай своё время",
"Будь настойчив и последовательен",
"Ищи решения а не оправдания",
"Окружай себя теми кто верит в тебя",
"Каждая победа начинается с решения попробовать",
"Живи с целью",
"Маленькие привычки приводят к большим результатам",
"Находи радость в процессе",
"Сделай сегодня лучше чем вчера",
"Планируй но действуй гибко",
"Улыбайся чаще это простая сила",
"Не стремись к совершенству стремись к прогрессу",
"Благодарность делает глаза шире",
"Цени путь а не только цель",
"Не бойся менять направление если нужно",
"Сохраняй спокойствие в трудные моменты",
"Ставь смелые цели и двигайся к ним"
]

# Функция загрузки состояния
def load_state():
    if os.path.exists(STATE_FILE):
        try:
            with open(STATE_FILE, "r", encoding="utf-8") as f:
                data = json.load(f)
                next_index = data.get("next_index", 0)
                # безопасность: ограничить диапазон
                if not isinstance(next_index, int) or next_index < 0 or next_index > len(QUOTES):
                    return 0
                return next_index
        except Exception as e:
            print("Ошибка загрузки состояния:", e)
            return 0
    else:
        return 0

# Функция сохранения состояния
def save_state(next_index):
    try:
        with open(STATE_FILE, "w", encoding="utf-8") as f:
            json.dump({"next_index": next_index}, f, ensure_ascii=False)
    except Exception as e:
        print("Ошибка сохранения состояния:", e)

# Инициализация индекса
next_quote_index = load_state()
print("Текущий индекс цитаты:", next_quote_index)

# Кнопка старт
@bot.message_handler(commands=['start'])
def start_cmd(message):
    keyboard = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    button = types.KeyboardButton("Получить цитату")
    keyboard.add(button)
    bot.send_message(message.chat.id, "Нажми кнопку чтобы получить цитату", reply_markup=keyboard)

# Обработка кнопки
@bot.message_handler(func=lambda message: message.text == "Получить цитату")
def handle_quote_request(message):
    global next_quote_index

    user_id = message.from_user.id
    # Проверяем подписку на все каналы
    subscribed_to_all = True
    not_subscribed = []

    for channel in SPONSORS:
        try:
            member = bot.get_chat_member(channel, user_id)
            print(f"Проверка {channel}: {member.status}")
            if member.status not in ["member", "administrator", "creator"]:
                subscribed_to_all = False
                not_subscribed.append(channel)
        except Exception as e:
            print(f"Ошибка при проверке {channel}: {e}")
            subscribed_to_all = False
            not_subscribed.append(channel)

    if not subscribed_to_all:
        # Формируем кнопки ссылок на каналы
        markup = types.InlineKeyboardMarkup()
        for ch in SPONSORS:
            url = f"https://t.me/{ch.lstrip('@')}"
            btn = types.InlineKeyboardButton(text=ch, url=url)
            markup.add(btn)
        # Отправляем сообщение с кнопками ссылок
        text = "*Вы не подписаны на все каналы\nПожалуйста подпишитесь на следующие каналы и попробуйте снова*"
        bot.send_message(message.chat.id, text, reply_markup=markup, parse_mode='Markdown')
        return

    # Если все подписаны, выдаём следующую цитату
    if next_quote_index >= len(QUOTES):
        bot.send_message(message.chat.id, "*Все цитаты закончились новых нет*", parse_mode='Markdown')
        return

    quote = QUOTES[next_quote_index]
    next_quote_index += 1
    # Сохраняем прогресс сразу после выдачи
    save_state(next_quote_index)
    # Отправляем жирный текст
    bot.send_message(message.chat.id, f"*{quote}*", parse_mode='Markdown')

# Запуск бота
print("Бот запущен...")
bot.infinity_polling()
